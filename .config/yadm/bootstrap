#!/bin/bash
set -e

# --- PHASE 1: PRE-FLIGHT CHECKS ---

# Force Yadm Checkout
if [ -f "$HOME/.config/yadm/bootstrap" ]; then
    echo "Ensuring dotfiles are checked out..."
    yadm checkout . || echo "Checkout had conflicts. Continuing..."
fi

# Verify Metapac Config exists
if [ ! -f "$HOME/.config/metapac/config.toml" ]; then
    echo "CRITICAL ERROR: config.toml not found!"
    echo "Metapac cannot snapshot the system without it."
    exit 1
fi

# --- PHASE 2: INSTALLATION ---

# 1. Install JUST (Critical Dependency)
if ! command -v just &> /dev/null; then
    echo "Installing Just..."
    sudo dnf install -y just
fi

# 2. Install Rust & Build Tools
# GCC/OpenSSL needed for compiling cargo-update
if ! command -v cargo &> /dev/null; then
    echo "Installing Rust & Build Tools..."
    sudo dnf install -y cargo gcc openssl-devel
fi

# 3. Install Metapac & Topgrade
if ! command -v metapac &> /dev/null; then
    echo "Installing Metapac & Topgrade..."
    cargo install cargo-update || true
    cargo install topgrade || true
    cargo install metapac || true
fi

# --- PHASE 3: THE SNAPSHOT ---

METAPAC_DIR="$HOME/.config/metapac/groups"
BASE_FILE="$METAPAC_DIR/base.toml"

mkdir -p "$METAPAC_DIR"

if [ ! -f "$BASE_FILE" ]; then
    echo "First Run: Snapshotting Base OS..."
    metapac unmanaged > "$BASE_FILE"
    echo "Base OS secured."
else
    echo "Base OS snapshot already exists. Skipping."
fi

# --- PHASE 4: HANDOFF ---

echo "Handing off to Justfile..."
just setup-system